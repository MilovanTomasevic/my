<!DOCTYPE html>
<html>

<head>
	<title>[High-performance computing (HPC)](/courses/#table-of-contents)</title>
	<meta charset="utf-8">
	<link rel="stylesheet" href="../remarkslides.css">
	<!-- MathJaxâ„¢ -->
	<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML" async>
	</script>
	<!-- mermaid dijagram -->
	<link rel="stylesheet2" href="../mermaid.min.css">
	<script>
		mermaid.initialize({startOnLoad:true});
	</script>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-127734928-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		      function gtag(){dataLayer.push(arguments);}
		      gtag('js', new Date());
		
		      gtag('config', 'UA-127734928-1');
	</script>
	<!-- google analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		      ga('create', 'UA-127734928-1', 'auto');
		      ga('send', 'pageview');
	</script>
</head>

<body>
	<textarea id="source">class: center, middle

## [High-performance computing (HPC)](/courses/#table-of-contents)
### V6-openACC


.author[[dr. Milovan TomaÅ¡eviÄ‡](https://milovantomasevic.com/resume/)]

.small[[Fakulteta za informacijske Å¡tudije v Novem mestu (FIÅ )](https://www.fis.unm.si/en/)</br>![:scale 10%](../fis/fis.png) .small[ [ğŸŒâ™ milovan.tomasevic.fis.unm.si](http://milovan.tomasevic.fis.unm.si)</br> [ğŸ“§â™ milovan.tomasevic@fis.unm.si](mailto:milovan.tomasevic@fis.unm.si)]]



.created[08.03.2019 u 17:55]


---


name: sadrzaj

# SadrÅ¾aj

- [OpenACC](#acc)
- [kernels direktiva](#kd)
- [parallel direktiva](#pd)
- [loop direktiva](#ld)
- [Model](#model)
- [data direktiva](#dd)
- [Zadaci](#zad)

---
name: acc
class: center, middle, inverse

# OpenACC

---
layout: true

.section[[OpenACC](#sadrzaj)]

---
## Å ta je OpenACC

- API za prebacivanje izvrÅ¡avanja delova koda na **akcelerator**.
- Obuhvata:
	- direktive (`pragma acc <direktiva>`)
	- promenljive okruÅ¾enja (eng. *runtime environment variables*)
	- biblioteÄke rutine (eng. *library routines*)
- PodrÅ¡ka za C, C++ i Fortran.
- Konceptualno veoma sliÄan OpenMP.

---

## Ciljna arhitektura

- Akceleratori.

.lcol[

![:scale 75%](img/acc2.png)
]

.rcol[

![:scale 110%](img/acc.jpg)

]

<br><br><br><br><br><br><br><br><br><br> 
- U laboratoriji Ä‡emo kao akcelerator koristiti **Nvidia Quadro** grafiÄke kartice.

---

## OpenACC kompajleri

![:scale 90%](img/compile.png)

- Na veÅ¾bama Ä‡emo koristiti GNU GCC kompajler.

.footer.medium[
[Izvor - OpenACC](https://www.openacc.org/tools)
] 

---

## Kompajliranje OpenACC programa

- Pozicionirati se u direktorijum u kojem se nalazi datoteka sa OpenACC kodom i u terminalu uneti:
```console
gcc -o izvrsna_dat izvorna_dat.c -fopenacc
```

- Za pokretanje programa, pozicionirati se u direktorijum u kojem je izvrÅ¡na datoteka i uneti `./izvrsna_dat`.
- Ukoliko program poziva neku od OpenACC funkcija (naziv poÄinje sa acc_), u izvornu datoteku je potrebno dodati i
```c
#include <openacc.h>
```

---

## Terminologija

- **DomaÄ‡in** (eng. *Host*) - centralna procesna jedinica sa svojom hijerarhijom memorije.
- **Akselerator** (eng. *Accelerator* ili *Device*) - akseleratorski ureÄ‘aj, npr. grafiÄka kartica.
- **Paralelni region** - Deo koda obeleÅ¾en za izvrÅ¡avanje na akceleratorskom ureÄ‘aju sa pridruÅ¾enim strukturama podataka. Obuhvata regione koda obeleÅ¾ene `parallel` i `kernels` direktivama (drugaÄije Ä‡e se zvati i raÄunski regioni).

---

## OpenACC model izvrÅ¡avanja

![:scale 50%](img/accModel.jpg)

.center[
`Figure`: Konceptualna arhitektura akseleratora.ref[*]
]

OpenACC podrÅ¾ava tri nivoa paralelizma: `gang, worker, vector`

.footer.medium[
  [* Link](https://www.sciencedirect.com/topics/computer-science/target-machine)
]

---

## OpenACC model izvrÅ¡avanja

OpÅ¡ti format OpenACC direktive:

```c
#pragma acc <directive> [clause-list] new-line
structured block
```
- Direktive za obeleÅ¾avanje paralelnog koda:
	- `kernels`
	- `parallel`

---
layout: false
name: kd
class: center, middle, inverse

# kernels direktiva

---
layout: true
.section[[kernels direktiva](#sadrzaj)]

---

## kernels direktiva

- OznaÄava deo koda koji moÅ¾e biti preveden za izvrÅ¡avanje na akceleratoru pravljenjem jednog ili viÅ¡e kernela. 
- Kompajler odluÄuje `Å¡ta` Ä‡e i `kako` Ä‡e paralelizovati.
```c
#pragma acc kernels [clause-list] new-line
structured block
```
- Neke od klauzula (parametri nisu navedeni):

.lcol[

- async
- copyin
- wait
]

.rcol[
- copyout
- copy
- ...
]

---

## Primer 1: kernel.c

```c
int main() {

	/* ... */
	#pragma acc kernels
	{
		for(i = 0; i < MATRIX_SIZE; i++)
			for(j = 0; j < MATRIX_SIZE; j++)
				randomMatrix[i * MATRIX_SIZE + j] =
				randomMatrix[i * MATRIX_SIZE + j] * 2;
	}

	return 0;
}

```

---

## Primer 2: <a target="_blank" rel="noopener noreferrer" href="/courses/hpc-z6-openACC/#table-of-contents"> â˜› Primeri/`ptraliasing.c`</a>

.message.is-dark[
.message-header[
Primer
]
.message-body[
```c
void assign(int *a, int *b, int size) {
	#pragma acc kernels
	{
		for (int i = 0; i < size - 1; i++)
			a[i] = b[i + 1];
	}
}
``` 
]
]

--
.message.is-info[
.message-header[
Zadatak
]
.message-body[
- **Pitanje**: Kada se koristi kernels direktiva, kompajler pronalazi delove koda koji su bezbedni za paralelizaciju, odnosno, u kojima nema zavisnosti meÄ‘u podacima. Å ta mislite, da li bi OpenACC kompajler preveo ovo u kod za paralelno izvrÅ¡avanje?
]
]

---

layout: false
name: pd
class: center, middle, inverse

# parallel direktiva

---
layout: true
.section[[parallel direktiva](#sadrzaj)]

---

## parallel direktiva

- OznaÄava deo koda koji Ä‡e biti preveden za izvrÅ¡avanje na akceleratoru. 
Kompajler odreÄ‘uje **kako** Ä‡e segment koda biti paralelizovan. 
Podrazumevano izvrÅ¡avanje kreÄ‡e u `gang-redundant` reÅ¾imu.
```C
#pragma acc parallel [clause-list] new-line
structured block
```
Neke od klauzula (parametri nisu navedeni):

.lcol[

- async
- wait
- num_gangs
- num_workers
- vector_length
]

.rcol[
- reduction
- copy
- copyin
- copyout
- ...
]

---

## Primer 3: <a target="_blank" rel="noopener noreferrer" href="/courses/hpc-z6-openACC/#table-of-contents"> â˜› Primeri/`parallel.c`</a>

.message.is-dark[
.message-header[
Primer
]
.message-body[
```c
#include <openacc.h>

int main() {
	float *values = (float *) malloc(sizeof(float) * size);

	#pragma acc parallel
	for (int i = 0; i < 1024; i++)
		values[i] = 1.f;
	free(values);

	return 0;
}
```
]
]

--
.message.is-info[
.message-header[
Zadatak
]
.message-body[
- **Pitanje**: Koliko puta Ä‡e svakom polju value niza biti dodeljena vrednost?
]
]

---

## parallel klauzule

- `async` - Nit koja je naiÅ¡la na parallel ili kernels direktivu (lokalna nit) moÅ¾e da nastavi izvrÅ¡avanje koda koji sledi iza paralelnog regiona bez Äekanja da ureÄ‘aj zavrÅ¡i svoj posao.
- `wait` - Kada naiÄ‘e na ovu klauzulu, lokalna nit Äeka.
- `num_gangs(int-exp)` - Broj `gang`-ova koji izvrÅ¡avaju paralelni region.
- `num_workers(int-exp)` - Broj radnika unutar `gang`-a.
- `vector_length(int-exp)` - DuÅ¾ina vektora koja se koristi za SIMD operacije.
- `reduction(op:var-list)` - Pravi lokalnu kopiju promenljive i inicijalizuje je. Na kraju paralelnog regiona se lokalne kopije redukuju.
- `copy, copyin, copyout`

---

layout: false
name: ld
class: center, middle, inverse

# loop direktiva

---
layout: true
.section[[loop direktiva](#sadrzaj)]

---

## loop direktiva

- Daje kompajleru dodatne informacije o tome kako da paralelizuje petlju na koju se odnosi direktiva. MoÅ¾e biti unutar `parallel` ili `kernels` direktiva.

```c
  #pragma acc loop [clause-list] new-line
    for loop
```
- Kombinovane konstrukcije:

```c
  #pragma acc parallel loop [clause-list] new-line
    for loop
```

```c
  #pragma acc kernels loop [clause-list] new-line
    for loop
```

---

## loop klauzule
- Klauzule za optimizaciju izvrÅ¡avanja:
	- `gang` - ParticioniÅ¡e iteracije izmeÄ‘u `gang`-ova. Prevodi izvrÅ¡avanje iz `gang-redundant` u `gang-partitioned` reÅ¾im. U sluÄaju ugnjeÅ¾denih petlji, spoljna mora biti `gang` petlja.
	- `worker` - PatricioniÅ¡e iteracije izmeÄ‘u `worker`-a. Prevodi izvrÅ¡avanje iz `worker-single` u `worker-partitioned` reÅ¾im. U sluÄaju ugnjeÅ¾denih petlji, bilo koja unutraÅ¡nja petlja, osim one najugnjeÅ¾denije, moÅ¾e biti `worker` petlja.
	- `vector` - Vektorizacija petlje (SIMD ili SIMT ). U sluÄaju ugnjeÅ¾denih petlji, najugnjeÅ¾denija je vector petlja.
	- `seq` - Petlja Ä‡e se izvrÅ¡iti sekvencijalno bez obzira na potencijalne optimizacije koje je kompajler pronaÅ¡ao. U suÄaju ugnjeÅ¾denih petlji, moÅ¾e biti na bilo kom nivou. 
- *Optimizacijom petlji se gubi na portabilnosti programa.*

---

##loop klauzule

- Ostale klauzule:
	- private
	- reduction
	- independent - Signalizira kompajleru da nema zavisnosti podataka izmeÄ‘u iteracija petlje.
	- ...

---

## Primer 4: <a target="_blank" rel="noopener noreferrer" href="/courses/hpc-z6-openACC/#table-of-contents"> â˜› Primeri/`parallelloop.c`</a>

```c
int main() {

	/* ... */

	#pragma acc parallel loop gang
	for (int i=0; i<N; i++)
		#pragma acc loop vector
		for (int j=0; j<M; j++)
			A[i * N + j] = 1.f;

	return 0;
}
```

---
layout: false
name: model
class: center, middle, inverse

# Model

---
layout: true
.section[[Model](#sadrzaj)]

---

## Model podataka i utican na na performanse

.lcol[

![:scale 95%](img/modelAcc.png)
]

.rcol[

![](img/modelAcc2.png)

]
<br><br><br><br><br><br><br><br><br><br><br>

- Optimizacija kernela bez optimizacije prenosa podataka obiÄno ne vodi poboljÅ¡anju performansi izvrÅ¡avanja programa!

.footer.medium[
	Izvor: [OpenACC Programming and Best Practices Guide](https://www.openacc.org/sites/default/files/inline-files/OpenACC_Programming_Guide_0.pdf)
] 

---

## Upravljanje podacima

- Prenos podataka izmeÄ‘u domaÄ‡ina i ureÄ‘aja je moguÄ‡e kontrolisati na viÅ¡e naÄina:
	- Bez bilo kakvog specificiranja ponaÅ¡anja, kompajler Ä‡e sam odrediti kada i koje podatke treba preneti sa domaÄ‡ina na ureÄ‘aj ili obrnuto.
	- Modifikovanjem ponaÅ¡anja `parallel` i `kernels` odgovarajuÄ‡im klauzulama za rad sa podacima (npr. `copy, copyin, copyout`...). Modifikacije vaÅ¾e za paralelni region nad kojim su primenjene klauzule za modfikaciju.
	- KoriÅ¡Ä‡enjem `data` direktive.
	- KoriÅ¡Ä‡enjem `data enter` i `data exit` direktiva (uglavnom za objektno programiranje).

---

layout: false
name: dd
class: center, middle, inverse

# data direktiva

---
layout: true
.section[[data direktiva](#sadrzaj)]

---

## data direktiva

- DefiniÅ¡e blok koda u kojem se klauzulama kontroliÅ¡e prenos podataka na relaciji domaÄ‡in ureÄ‘aj.
```c
#pragma acc data [clause-list] new-line
structured block
```
	- copy
	- copyin
	- copyout
	- create
	- present

---

## Primer 5: <a target="_blank" rel="noopener noreferrer" href="/courses/hpc-z6-openACC/#table-of-contents"> â˜› Primeri/`data.c`</a>

```c
int main() {
	/* ... */
	#pragma acc data
	{
		#pragma acc parallel loop
		for (int i=0; i<N; i++) {
			y[i] = 0.0f;
			x[i] = (float)(i+1);
		}
		#pragma acc parallel loop
		for (int i=0; i<N; i++) {
			y[i] = 2.0f * x[i] + y[i];
		}
	}
	/* ... */
}
```

---

## Klauzule
- `copy(var-list)` - Alocira prostor za promenljive na ureÄ‘aju, kopira vrednosti sa domaÄ‡ina na ureÄ‘aj i sa ureÄ‘aja nazad na domaÄ‡ina kada se zavrÅ¡i blok podataka (ili `parallel` i `kernels` blok ako klauzula stoji uz njih)
- `copyin(var-list)` - Alocira prostor za promenljive na ureÄ‘aju i kopira vrednosti sa domaÄ‡ina na ureÄ‘aj. Po zavrÅ¡etku bloka ne prenosi vrednosti nazad na domaÄ‡ina.
- `copyout(var-list)` - Alocira prostor za promenljive na ureÄ‘aju bez inicijalizacije podacima sa domaÄ‡ina. Po zavrÅ¡etku bloka, podaci se prenose sa ureÄ‘aja na domaÄ‡ina.
- `create(var-list)` - Alocira prostor za promenljive na ureÄ‘aju bez inicijalizacije. Vrednosti promenljivih se na kraju bloka ne prebacuju na domaÄ‡ina.
- `present(var-list)` - OznaÄava da su promenljive prisutne u memoriji ureÄ‘aja.

---

## OpenACC promenljive okruÅ¾enja

- GNU GCC kompajler:
	- `ACC_DEVICE_TYPE` (standard)
	- `ACC_DEVICE_NUM` (standard)
	- `ACC_PROF` (standard)
	- `GOPMP_OPENACC_DIM` (gcc)
	- `GOMP_DEBUG` (gcc)

---

layout: false
name: zad
class: center, middle, inverse

# Zadaci

---
layout: true
.section[[Zadaci](#sadrzaj)]

---

## Zadatak 1: RaÄunanje broja Ï€

.message.is-info[
.message-header[
Zadatak
]
.message-body[
- Modifikovati dati sekvencijalni program za raÄunanje vrednosti broja Ï€ koriÅ¡Ä‡enjem OpenACC direktiva. Koristiti NVIDIA grafiÄku karticu kao akcelerator (GNU GCC trenutno ne podrÅ¾ava Radeon kartice). 
- Meriti izvrÅ¡avanje sekvencijalnog i implementiranog ubrzanog programa.
]
]

--
.message.is-warning[
.message-header[
Info
]
.message-body[
- **Napomena**: Zadatak svakako implementirati i u sluÄaju da na raÄunaru nemate dostupnu NVIDIA grafiÄku karticu.
]
]

---

## Zadatak 2: RaÄunanje Jakobijana

.message.is-info[
.message-header[
Zadatak
]
.message-body[
- Modifikovati dati sekvencijalni program za raÄunanje Jakobijana.
- Osnovnu verziju programa u C++ programskom jeziku skinuti sa
- Githab naloga OpenACCUserGroup.Koristiti NVIDIA grafiÄku karticu kao akcelerator (GNU GCC trenutno ne podrÅ¾ava Radeon kartice). 
- Meriti izvrÅ¡avanje sekvencijalnog i implementiranog ubrzanog programa.
]
]

--
.message.is-warning[
.message-header[
Info
]
.message-body[
- **Napomena**: Zadatak svakako implementirati i u sluÄaju da na raÄunaru nemate dostupnu NVIDIA grafiÄku karticu.
]
]

---

## Saveti za inkrementalno portovanje sekvencijalnog u OpenACC kod

1. Identifikovati paralelizam petlji. Paralelizovati deo po deo sekvencijalnog koda pri tom kontroliÅ¡uÄ‡i korektnost izvrÅ¡avanja programa. Nastaviti sa ovim tipom optimizacije bez obzira na to da li se vreme izvrÅ¡avanja poveÄ‡ava.

2. Optimizovati prenos podataka. Preklopiti prenos podataka sa raÄunanjem, ukloniti nepotrebna kopiranja, aÅ¾uriranja promenljivih, itd...

3. Paralelizovane petlje optimizovati za ciljnu arhitekturu koriÅ¡Ä‡enjem klauzula.

.footer.medium[
Izvor: [OpenACC Programming and Best Practices Guide](https://www.openacc.org/sites/default/files/inline-files/OpenACC_Programming_Guide_0.pdf)
]

---
layout: false
## Literatura

- Tekstualni materijali:
	- [OpenACC Programming and Best Practices Guide](https://www.openacc.org/sites/default/files/inline-files/OpenACC_Programming_Guide_0.pdf)
	- [OpenACC Specification 2.5](https://www.openacc.org/sites/default/files/inline-files/OpenACC_2pt5.pdf)
	- [GNU GCC OpenACC Wiki](https://gcc.gnu.org/wiki/OpenACC)
	- David B. Kirk, Wen-mei W. Hwu, Programming Massively Parallel Processors, A Hands on Approach, 2nd edition, 2012
	- [Advanced OpenACC](http://videolectures.net/site/normal_dl/tag=1058329/ihpcss2016_urbanic_advanced_openACC_01.pdf)
- Video tutorijali:
	- [Introduction to Parallel Programming with OpenACC](https://www.youtube.com/playlist?list=PLx_s9Cz7_T429SF7gBGJ51iiZoEWYVvkq)
	- [Advanced OpenACC](http://videolectures.net/ihpcss2016_urbanic_advanced_openACC/)

--

class: center, middle, theend, hide-text
layout: false
background-image: url(../theend.gif)

</textarea>
	<script src="../remark-latest.min.js"></script>
	<script>
		// https://github.com/gnab/remark/issues/72
		        remark.macros.scale = function (percentage) {
		            var url = this;
		            return '<div class="center"><img src="'
		                 + url + '" style="width: ' + percentage + '" /></div>';
		        };
		        var slideshow = remark.create({
		                    highlightLanguage: 'python',
		                    // highlightStyle: 'obsidian',
		                    highlightStyle: 'github',
		                    highlightLines: true,
		                    countIncrementalSlides: false,
		                    navigation: {
		                      // Enable or disable navigating using scroll
		                      // Default: true
		                      // Alternatives: false
		                      scroll: false,
		
		                      //click: true,
		                    }
		                });
	</script>
	<script src="../mermaid.min.js"></script>
	<script>
		mermaid.initialize({startOnLoad:true});
	</script></body>

</html>